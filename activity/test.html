<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Activity Test</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    html, body { width: 100%; height: 100%; overflow: hidden; background: #0c0c0e; }

    #loading {
      position: absolute; inset: 0;
      display: flex; flex-direction: column;
      align-items: center; justify-content: center;
      color: #a78bfa; font-family: system-ui, sans-serif;
      z-index: 100;
    }
    #loading.hidden { display: none; }
    #loading .spinner {
      width: 48px; height: 48px;
      border: 4px solid rgba(167, 139, 250, 0.2);
      border-top-color: #a78bfa;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
    }
    #loading .status { margin-top: 16px; font-size: 14px; opacity: 0.9; }
    #loading .progress { margin-top: 8px; font-size: 12px; opacity: 0.6; }
    @keyframes spin { to { transform: rotate(360deg); } }

    #unity-container { width: 100%; height: 100%; }
    #unity-canvas { width: 100%; height: 100%; background: #0c0c0e; }
  </style>
</head>
<body>
  <div id="loading">
    <div class="spinner"></div>
    <div class="status" id="status-text">Loading Unity build...</div>
    <div class="progress" id="progress-text"></div>
  </div>

  <div id="unity-container">
    <canvas id="unity-canvas" tabindex="-1"></canvas>
  </div>

  <script>
    function setStatus(text) {
      const el = document.getElementById("status-text");
      if (el) el.textContent = text;
    }
    function setProgress(text) {
      const el = document.getElementById("progress-text");
      if (el) el.textContent = text;
    }

    // Stub bridge so Unity C# calls don't error
    window.discordBridge = {
      getUser: () => JSON.stringify({ id: "test", username: "TestUser", globalName: "Test User", avatar: "" }),
      getContext: () => JSON.stringify({ guildId: "", channelId: "", instanceId: "" }),
    };

    async function loadUnity() {
      const loaderScript = document.createElement("script");
      loaderScript.src = "/activity/Build/Builds.loader.js";

      await new Promise((resolve, reject) => {
        loaderScript.onload = resolve;
        loaderScript.onerror = () => reject(new Error("Failed to load Unity loader — check Build/ files"));
        document.body.appendChild(loaderScript);
      });

      if (typeof createUnityInstance !== "function") {
        throw new Error("createUnityInstance not found — check Unity build output");
      }

      const canvas = document.getElementById("unity-canvas");

      const instance = await createUnityInstance(canvas, {
        dataUrl:            "/activity/Build/Builds.data.gz",
        frameworkUrl:       "/activity/Build/Builds.framework.js.gz",
        codeUrl:            "/activity/Build/Builds.wasm.gz",
        streamingAssetsUrl: "/activity/StreamingAssets",
        companyName:        "Aeveon",
        productName:        "AeloraActivity",
        productVersion:     "1.0",
      }, (progress) => {
        setProgress(`${Math.round(progress * 100)}%`);
      });

      document.getElementById("loading").classList.add("hidden");

      // Notify Unity with test data
      instance.SendMessage("DiscordManager", "OnDiscordReady", JSON.stringify({
        user: { id: "test", username: "TestUser", globalName: "Test User", avatar: "" },
        context: { guildId: "", channelId: "", instanceId: "" },
      }));
    }

    loadUnity().catch((err) => {
      console.error("Unity load failed:", err);
      setStatus(`Error: ${err.message}`);
    });
  </script>
</body>
</html>
