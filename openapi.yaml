openapi: 3.1.0
info:
  title: Aelora API
  version: 1.0.0
  description: |
    REST API for the Aelora bot platform. Powers the web dashboard and can be used
    by external services to manage personas, memory, scheduled tasks, and more.

    ## Authentication

    When `web.apiKey` is set in `settings.yaml`, all routes (except those marked Public)
    require a bearer token:

    ```
    Authorization: Bearer <your-api-key>
    ```

    For SSE endpoints (EventSource can't set headers), use a query parameter instead:

    ```
    GET /api/logs/stream?token=<your-api-key>
    ```

    When no API key is configured, all routes are open.

    ## Rate Limiting

    - **General:** 1000 requests / 15 minutes per IP on all `/api/*` routes
    - **Chat:** 60 requests / minute per IP on `/api/chat` and `/api/chat/stream`

    Rate limit headers (`RateLimit-*`) are included in responses.

servers:
  - url: /
    description: Current server (auto-detect)
  - url: http://localhost:3000
    description: Local development

tags:
  - name: Status
    description: Health check and bot state
  - name: Config
    description: Bot configuration (sanitized, no secrets)
  - name: Persona
    description: Persona management, file editing, switching
  - name: Chat
    description: Conversation API with full session state (rate limited to 60/min)
  - name: Cron
    description: Scheduled task management
  - name: Sessions
    description: Conversation session analytics
  - name: Memory
    description: Fact storage, daily logs, conversation summaries
  - name: Notes
    description: Persistent note storage with scope-based organization
  - name: Calendar
    description: CalDAV calendar event queries (read-only)
  - name: Todos
    description: Task management via CalDAV VTODO
  - name: Users
    description: User profile tracking across channels
  - name: Tools
    description: Tool registry management
  - name: Agents
    description: Agent registry management
  - name: System
    description: Heartbeat, logs, reboot
  - name: Export
    description: Data export (full or selective JSON bundle)
  - name: Activity
    description: Discord Activity (Unity WebGL) support
  - name: WebSocket
    description: |
      Real-time bidirectional chat via WebSocket at `ws://host:port/ws`.

      **Connection:** `ws://host:port/ws?token=API_KEY` (token required if `web.apiKey` is set).

      **Protocol (JSON):**

      Client → Server:
      - `{ "type": "init", "sessionId": "...", "userId?": "...", "username?": "..." }` — bind session
      - `{ "type": "message", "content": "..." }` — send chat message
      - `{ "type": "clear" }` — start new session (clears history, summary, context, and session stats)

      Server → Client:
      - `{ "type": "ready", "sessionId": "..." }` — session bound
      - `{ "type": "token", "content": "..." }` — streamed response chunk
      - `{ "type": "done", "reply": "..." }` — full response
      - `{ "type": "error", "error": "..." }` — error message
      - `{ "type": "event", "event": "mood", "data": {...} }` — live broadcast event

components:
  securitySchemes:
    BearerAuth:
      type: http
      scheme: bearer
    QueryToken:
      type: apiKey
      in: query
      name: token

  schemas:
    Error:
      type: object
      properties:
        error:
          type: string
      required: [error]

    Success:
      type: object
      properties:
        success:
          type: boolean

    Status:
      type: object
      properties:
        connected:
          type: boolean
        username:
          type: string
          nullable: true
        userId:
          type: string
          nullable: true
        guildCount:
          type: integer
        uptime:
          type: number
          description: Seconds since boot
        authRequired:
          type: boolean

    CronJob:
      type: object
      properties:
        name:
          type: string
        schedule:
          type: string
          description: Cron expression (e.g. "0 9 * * *")
        timezone:
          type: string
        channelId:
          type: string
        type:
          type: string
          enum: [static, llm]
        message:
          type: string
          description: Static message (when type=static)
        prompt:
          type: string
          description: LLM prompt (when type=llm)
        enabled:
          type: boolean
        silent:
          type: boolean
          description: When true, job runs without sending output to Discord. History is still recorded.
        lastRun:
          type: string
          format: date-time
          nullable: true
        nextRun:
          type: string
          format: date-time
          nullable: true
        lastError:
          type: string
          nullable: true
        history:
          type: array
          items:
            type: object
            properties:
              timestamp:
                type: string
                format: date-time
              success:
                type: boolean
              durationMs:
                type: integer
              outputPreview:
                type: string
              error:
                type: string

    Session:
      type: object
      properties:
        channelId:
          type: string
        channelName:
          type: string
        guildId:
          type: string
          nullable: true
        messageCount:
          type: integer
        firstMessage:
          type: string
          format: date-time
        lastMessage:
          type: string
          format: date-time
        users:
          type: object
          additionalProperties:
            type: object
            properties:
              username:
                type: string
              messageCount:
                type: integer
              lastMessage:
                type: string
                format: date-time

    MemoryFact:
      type: object
      properties:
        fact:
          type: string
        savedAt:
          type: string
          format: date-time

    Tool:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        parameters:
          type: object
          nullable: true
          description: JSON Schema for tool arguments (OpenAI function calling format)

    Agent:
      type: object
      properties:
        name:
          type: string
        description:
          type: string
        enabled:
          type: boolean
        tools:
          type: array
          items:
            type: string
        maxIterations:
          type: integer
          nullable: true
        model:
          type: string
          nullable: true

    PersonaFile:
      type: object
      properties:
        path:
          type: string
        content:
          type: string
        meta:
          type: object
          properties:
            label:
              type: string
            section:
              type: string
            order:
              type: integer
            enabled:
              type: boolean
            description:
              type: string
            botName:
              type: string

    LogEntry:
      type: object
      properties:
        ts:
          type: string
          format: date-time
        level:
          type: string
          enum: [log, warn, error]
        message:
          type: string

    Note:
      type: object
      properties:
        content:
          type: string
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time
      required: [content, createdAt, updatedAt]

    CalendarEvent:
      type: object
      properties:
        uid:
          type: string
        summary:
          type: string
        description:
          type: string
        location:
          type: string
        dtstart:
          type: string
          format: date-time
          description: Event start in ISO 8601
        dtend:
          type: string
          format: date-time
          description: Event end in ISO 8601
        url:
          type: string
          description: CalDAV object URL
        etag:
          type: string

    UserProfile:
      type: object
      properties:
        userId:
          type: string
        username:
          type: string
          description: Latest Discord display name
        firstSeen:
          type: string
          format: date-time
        lastSeen:
          type: string
          format: date-time
        messageCount:
          type: integer
        channels:
          type: array
          items:
            type: string
          description: Channel IDs the user has been active in
      required: [userId, username, firstSeen, lastSeen, messageCount, channels]

    TodoItem:
      type: object
      description: A task stored as a CalDAV VTODO
      properties:
        uid:
          type: string
          description: CalDAV UID (use for complete/update/delete)
        title:
          type: string
        description:
          type: string
          nullable: true
        completed:
          type: boolean
        priority:
          type: string
          enum: [low, medium, high]
        dueDate:
          type: string
          format: date-time
          nullable: true
        url:
          type: string
          description: CalDAV object URL
        etag:
          type: string
          description: ETag for conflict detection
        createdAt:
          type: string
          format: date-time
          nullable: true
        updatedAt:
          type: string
          format: date-time
          nullable: true
      required: [uid, title, completed, priority, url, etag]

security:
  - BearerAuth: []

paths:
  # ── Docs ───────────────────────────────────────────────
  /api/docs:
    get:
      tags: [Status]
      summary: Interactive API documentation
      description: Swagger UI for exploring and testing the API. Always public.
      security: []
      responses:
        "200":
          description: Swagger UI HTML page
          content:
            text/html:
              schema:
                type: string

  /api/docs/openapi.yaml:
    get:
      tags: [Status]
      summary: OpenAPI specification
      description: Raw OpenAPI 3.1 YAML specification. Always public.
      security: []
      responses:
        "200":
          description: OpenAPI YAML
          content:
            text/yaml:
              schema:
                type: string

  # ── Status ──────────────────────────────────────────────
  /api/status:
    get:
      tags: [Status]
      summary: Bot status
      description: Connection state, uptime, guild count, and whether auth is required. Always public.
      security: []
      responses:
        "200":
          description: Bot status
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Status"

  # ── Config ──────────────────────────────────────────────
  /api/config:
    get:
      tags: [Config]
      summary: Sanitized config
      description: Returns bot configuration with secrets stripped.
      responses:
        "200":
          description: Config object
          content:
            application/json:
              schema:
                type: object
        "401":
          description: Unauthorized
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── Persona ─────────────────────────────────────────────
  /api/persona:
    get:
      tags: [Persona]
      summary: Active persona state
      description: File inventory, prompt stats, and active persona info.
      responses:
        "200":
          description: Persona state
          content:
            application/json:
              schema:
                type: object
                properties:
                  enabled:
                    type: boolean
                  activePersona:
                    type: string
                  botName:
                    type: string
                  loadedAt:
                    type: string
                    format: date-time
                  promptLength:
                    type: integer
                  files:
                    type: array
                    items:
                      type: object
                      properties:
                        path:
                          type: string
                        label:
                          type: string
                        section:
                          type: string
                        order:
                          type: integer
                        enabled:
                          type: boolean
                        contentLength:
                          type: integer

  /api/persona/reload:
    post:
      tags: [Persona]
      summary: Reload persona from disk
      description: Hot-reloads all persona files and recomposes the system prompt.
      responses:
        "200":
          description: Reload result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  activePersona:
                    type: string
                  botName:
                    type: string
                  promptLength:
                    type: integer
                  fileCount:
                    type: integer
                  enabledCount:
                    type: integer

  /api/personas:
    get:
      tags: [Persona]
      summary: List all personas
      description: Returns all available personas with descriptions for the card grid.
      responses:
        "200":
          description: Persona list
          content:
            application/json:
              schema:
                type: object
                properties:
                  personas:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        botName:
                          type: string
                        description:
                          type: string
                        fileCount:
                          type: integer
                  activePersona:
                    type: string
    post:
      tags: [Persona]
      summary: Create a new persona
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                  description: Folder name (lowercase, hyphens)
                description:
                  type: string
                botName:
                  type: string
                  description: Character display name
              required: [name]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/persona/switch:
    post:
      tags: [Persona]
      summary: Switch active persona
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                persona:
                  type: string
              required: [persona]
      responses:
        "200":
          description: Switched
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  activePersona:
                    type: string
                  botName:
                    type: string
                  promptLength:
                    type: integer

  /api/persona/files:
    get:
      tags: [Persona]
      summary: List all persona files
      description: Returns all files across all personas with content.
      responses:
        "200":
          description: File list
          content:
            application/json:
              schema:
                type: object
                properties:
                  files:
                    type: array
                    items:
                      $ref: "#/components/schemas/PersonaFile"

  /api/persona/file:
    get:
      tags: [Persona]
      summary: Get a persona file
      parameters:
        - name: path
          in: query
          required: true
          schema:
            type: string
          description: Relative path (e.g. "aelora/persona.md")
      responses:
        "200":
          description: File content and metadata
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/PersonaFile"
        "404":
          description: File not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags: [Persona]
      summary: Create a new persona file
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
                content:
                  type: string
                meta:
                  type: object
              required: [path]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
    put:
      tags: [Persona]
      summary: Update a persona file
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
                content:
                  type: string
                meta:
                  type: object
              required: [path, content]
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
    delete:
      tags: [Persona]
      summary: Delete a persona file
      description: |
        Path can be provided either as a query parameter or in the request body.
        Query parameter takes precedence if both are supplied.
      parameters:
        - name: path
          in: query
          schema:
            type: string
          description: Relative path (e.g. "aelora/notes.md"). Alternative to request body.
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                path:
                  type: string
              required: [path]
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"

  # ── Chat ─────────────────────────────────────────────────
  /api/chat:
    post:
      tags: [Chat]
      summary: Send a message
      description: |
        Send a message and receive a response with full conversation state.
        Uses `sessionId` to maintain conversation history across requests.
        Optionally provide `userId` and `username` to enable user-scoped memory and session tracking.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message, sessionId]
              properties:
                message:
                  type: string
                  description: The user's message
                sessionId:
                  type: string
                  description: Conversation identifier (maps to internal channelId)
                userId:
                  type: string
                  description: Optional user identifier for memory and tracking
                username:
                  type: string
                  description: Optional display name (required if userId is provided)
      responses:
        "200":
          description: Bot response
          content:
            application/json:
              schema:
                type: object
                properties:
                  reply:
                    type: string
                  sessionId:
                    type: string
        "400":
          description: Missing required fields
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  /api/chat/stream:
    post:
      tags: [Chat]
      summary: Send a message (streaming)
      description: |
        Same as POST /api/chat but streams tokens via Server-Sent Events.
        Each token is sent as `data: {"token":"..."}`.
        Final event is `data: {"done":true,"reply":"..."}`.
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [message, sessionId]
              properties:
                message:
                  type: string
                sessionId:
                  type: string
                userId:
                  type: string
                username:
                  type: string
      responses:
        "200":
          description: SSE stream of tokens
          content:
            text/event-stream:
              schema:
                type: string

  /api/chat/{sessionId}:
    delete:
      tags: [Chat]
      summary: Start new session
      description: Full session reset — clears conversation history, summary, compaction queue, and session stats. The next message starts completely fresh.
      parameters:
        - name: sessionId
          in: path
          required: true
          schema:
            type: string
          description: The session to reset
      responses:
        "200":
          description: Session reset
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean

  # ── Cron ────────────────────────────────────────────────
  /api/cron:
    get:
      tags: [Cron]
      summary: List all cron jobs
      responses:
        "200":
          description: Job list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/CronJob"
    post:
      tags: [Cron]
      summary: Create a cron job
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                name:
                  type: string
                schedule:
                  type: string
                timezone:
                  type: string
                channelId:
                  type: string
                  description: Required unless silent is true
                type:
                  type: string
                  enum: [static, llm]
                message:
                  type: string
                prompt:
                  type: string
                enabled:
                  type: boolean
                silent:
                  type: boolean
                  description: Run without sending output to Discord
              required: [name, schedule, type]
      responses:
        "200":
          description: Created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "400":
          description: Validation error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/cron/{name}:
    put:
      tags: [Cron]
      summary: Update a cron job
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                schedule:
                  type: string
                timezone:
                  type: string
                channelId:
                  type: string
                type:
                  type: string
                  enum: [static, llm]
                message:
                  type: string
                prompt:
                  type: string
                silent:
                  type: boolean
      responses:
        "200":
          description: Updated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags: [Cron]
      summary: Delete a cron job
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/cron/{name}/toggle:
    post:
      tags: [Cron]
      summary: Toggle a cron job on/off
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Toggle result
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  enabled:
                    type: boolean
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/cron/{name}/trigger:
    post:
      tags: [Cron]
      summary: Manually trigger a cron job
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Trigger result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  output:
                    type: string
                  error:
                    type: string
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── Sessions ────────────────────────────────────────────
  /api/sessions:
    get:
      tags: [Sessions]
      summary: List all sessions
      responses:
        "200":
          description: Session list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Session"
    delete:
      tags: [Sessions]
      summary: Clear all sessions
      responses:
        "200":
          description: Cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  deleted:
                    type: integer

  /api/sessions/{channelId}:
    get:
      tags: [Sessions]
      summary: Session detail
      description: Includes per-user stats and related memory facts.
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Session with memories
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/Session"
                  - type: object
                    properties:
                      memories:
                        type: object
                        additionalProperties:
                          type: array
                          items:
                            $ref: "#/components/schemas/MemoryFact"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags: [Sessions]
      summary: Delete a session
      parameters:
        - name: channelId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── Memory ──────────────────────────────────────────────
  /api/memory:
    get:
      tags: [Memory]
      summary: All stored facts
      description: Returns all memory facts grouped by scope.
      responses:
        "200":
          description: Facts by scope
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: array
                  items:
                    $ref: "#/components/schemas/MemoryFact"

  /api/memory/{scope}/{index}:
    delete:
      tags: [Memory]
      summary: Delete a specific fact
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
          description: "Scope key (e.g. user:123, channel:456, global)"
        - name: index
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "404":
          description: Fact not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/memory/{scope}:
    delete:
      tags: [Memory]
      summary: Clear all facts in a scope
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Cleared
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  deleted:
                    type: integer

  /api/memory/logs:
    get:
      tags: [Memory]
      summary: List daily log dates
      description: Returns an array of date strings (YYYY-MM-DD) for which logs exist.
      responses:
        "200":
          description: Date list
          content:
            application/json:
              schema:
                type: array
                items:
                  type: string

  /api/memory/logs/{date}:
    get:
      tags: [Memory]
      summary: Read a daily log
      parameters:
        - name: date
          in: path
          required: true
          schema:
            type: string
          description: Date in YYYY-MM-DD format
      responses:
        "200":
          description: Log content
          content:
            application/json:
              schema:
                type: object
                properties:
                  date:
                    type: string
                  content:
                    type: string
        "404":
          description: No log for that date
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/memory/summaries:
    get:
      tags: [Memory]
      summary: Conversation summaries
      description: Returns compacted conversation summaries keyed by channel ID.
      responses:
        "200":
          description: Summaries
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  properties:
                    summary:
                      type: string
                    updatedAt:
                      type: string
                      format: date-time

  # ── Notes ───────────────────────────────────────────────
  /api/notes:
    get:
      tags: [Notes]
      summary: List all notes
      description: Returns every note across all scopes (global, channel-specific).
      responses:
        "200":
          description: Note store keyed by scope
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  type: object
                  additionalProperties:
                    $ref: "#/components/schemas/Note"

  /api/notes/{scope}:
    get:
      tags: [Notes]
      summary: List notes in a scope
      description: Returns all notes within a specific scope (e.g. `global` or `channel:123456`).
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
          description: "Note scope (e.g. `global`, `channel:123456`)"
      responses:
        "200":
          description: Notes in the requested scope
          content:
            application/json:
              schema:
                type: object
                properties:
                  scope:
                    type: string
                  notes:
                    type: object
                    additionalProperties:
                      $ref: "#/components/schemas/Note"
                  count:
                    type: integer

  /api/notes/{scope}/{title}:
    get:
      tags: [Notes]
      summary: Get a single note
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
        - name: title
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: The requested note
          content:
            application/json:
              schema:
                type: object
                properties:
                  scope:
                    type: string
                  title:
                    type: string
                  content:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time
        "404":
          description: Note not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

    put:
      tags: [Notes]
      summary: Create or update a note
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
        - name: title
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              required: [content]
              properties:
                content:
                  type: string
                  description: The note content
      responses:
        "200":
          description: Note created or updated
          content:
            application/json:
              schema:
                type: object
                properties:
                  scope:
                    type: string
                  title:
                    type: string
                  content:
                    type: string
                  createdAt:
                    type: string
                    format: date-time
                  updatedAt:
                    type: string
                    format: date-time
                  created:
                    type: boolean
                    description: True if newly created, false if updated
        "400":
          description: Missing content
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

    delete:
      tags: [Notes]
      summary: Delete a note
      parameters:
        - name: scope
          in: path
          required: true
          schema:
            type: string
        - name: title
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Note deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "404":
          description: Note not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  # ── Calendar ────────────────────────────────────────────
  /api/calendar/events:
    get:
      tags: [Calendar]
      summary: List upcoming events
      description: Returns upcoming calendar events from the configured CalDAV server. Read-only.
      parameters:
        - name: maxResults
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 50
            default: 10
          description: Maximum number of events to return
        - name: daysAhead
          in: query
          schema:
            type: integer
            minimum: 1
            maximum: 365
            default: 14
          description: How many days ahead to query
      responses:
        "200":
          description: List of upcoming events
          content:
            application/json:
              schema:
                type: object
                properties:
                  events:
                    type: array
                    items:
                      $ref: "#/components/schemas/CalendarEvent"
                  count:
                    type: integer
                  daysAhead:
                    type: integer
                  maxResults:
                    type: integer
        "502":
          description: CalDAV connection failure
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string
        "503":
          description: CalDAV not configured
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  # ── Todos (CalDAV VTODO) ────────────────────────────────
  /api/todos:
    get:
      tags: [Todos]
      summary: List all todos
      description: Returns todos from the CalDAV server. Filter by status.
      parameters:
        - name: status
          in: query
          schema:
            type: string
            enum: [all, pending, completed]
            default: all
      responses:
        "200":
          description: Todo list
          content:
            application/json:
              schema:
                type: object
                properties:
                  todos:
                    type: array
                    items:
                      $ref: "#/components/schemas/TodoItem"
                  count:
                    type: integer
        "502":
          description: CalDAV connection error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "503":
          description: CalDAV not configured
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    post:
      tags: [Todos]
      summary: Create a new todo
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                priority:
                  type: string
                  enum: [low, medium, high]
                dueDate:
                  type: string
                  format: date-time
              required: [title]
      responses:
        "201":
          description: Todo created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoItem"
        "400":
          description: Missing title
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "502":
          description: CalDAV connection error
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/todos/{uid}:
    get:
      tags: [Todos]
      summary: Get a single todo
      parameters:
        - name: uid
          in: path
          required: true
          description: CalDAV UID of the todo
          schema:
            type: string
      responses:
        "200":
          description: Todo item
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoItem"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    put:
      tags: [Todos]
      summary: Update a todo
      parameters:
        - name: uid
          in: path
          required: true
          description: CalDAV UID of the todo
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                title:
                  type: string
                description:
                  type: string
                priority:
                  type: string
                  enum: [low, medium, high]
                dueDate:
                  type: string
                  format: date-time
                completed:
                  type: boolean
                  description: Set to true to mark as completed
      responses:
        "200":
          description: Updated todo
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TodoItem"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
    delete:
      tags: [Todos]
      summary: Delete a todo
      parameters:
        - name: uid
          in: path
          required: true
          description: CalDAV UID of the todo
          schema:
            type: string
      responses:
        "200":
          description: Deleted
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Success"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── Users ───────────────────────────────────────────────
  /api/users:
    get:
      tags: [Users]
      summary: List all user profiles
      description: Returns every tracked user profile, keyed by Discord user ID.
      responses:
        "200":
          description: User store keyed by userId
          content:
            application/json:
              schema:
                type: object
                additionalProperties:
                  $ref: "#/components/schemas/UserProfile"

  /api/users/{userId}:
    get:
      tags: [Users]
      summary: Get user profile with memory facts
      description: Returns a user's profile enriched with their stored memory facts.
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
          description: Discord user ID
      responses:
        "200":
          description: User profile with facts
          content:
            application/json:
              schema:
                allOf:
                  - $ref: "#/components/schemas/UserProfile"
                  - type: object
                    properties:
                      facts:
                        type: array
                        items:
                          $ref: "#/components/schemas/MemoryFact"
        "404":
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

    delete:
      tags: [Users]
      summary: Delete user profile
      description: Removes a user profile and cascade-deletes their memory facts (user:{userId} scope).
      parameters:
        - name: userId
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: User deleted
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
        "404":
          description: User not found
          content:
            application/json:
              schema:
                type: object
                properties:
                  error:
                    type: string

  # ── Tools ───────────────────────────────────────────────
  /api/tools:
    get:
      tags: [Tools]
      summary: List all tools
      responses:
        "200":
          description: Tool list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Tool"

  /api/tools/{name}:
    get:
      tags: [Tools]
      summary: Get a single tool's details
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Tool detail
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Tool"
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/tools/{name}/execute:
    post:
      tags: [Tools]
      summary: Execute a tool directly
      description: |
        Call any enabled tool with arguments. Uses the same execution path
        as LLM tool calls. Optional channelId and userId provide context
        for scoped tools (memory, notes, etc.).
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                args:
                  type: object
                  description: Tool arguments (varies per tool, see tool's parameters schema)
                channelId:
                  type: string
                  nullable: true
                  description: Optional channel context for scoped tools
                userId:
                  type: string
                  nullable: true
                  description: Optional user context for scoped tools
      responses:
        "200":
          description: Execution result
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  tool:
                    type: string
                  result:
                    type: string
                    description: Human-readable text result (always present, backward compatible)
                  data:
                    description: >
                      Structured JSON data for the tool response. Shape varies per tool and action.
                      Present when the tool provides structured output. Omitted on error responses.
                      Typically includes an `action` field and typed result objects.
        "400":
          description: Tool is disabled
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
        "404":
          description: Tool not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  /api/tools/{name}/toggle:
    post:
      tags: [Tools]
      summary: Toggle a tool on/off
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Toggle result
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  enabled:
                    type: boolean
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── Agents ──────────────────────────────────────────────
  /api/agents:
    get:
      tags: [Agents]
      summary: List all agents
      responses:
        "200":
          description: Agent list
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/Agent"

  /api/agents/{name}/toggle:
    post:
      tags: [Agents]
      summary: Toggle an agent on/off
      parameters:
        - name: name
          in: path
          required: true
          schema:
            type: string
      responses:
        "200":
          description: Toggle result
          content:
            application/json:
              schema:
                type: object
                properties:
                  name:
                    type: string
                  enabled:
                    type: boolean
        "404":
          description: Not found
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"

  # ── System ──────────────────────────────────────────────
  /api/heartbeat:
    get:
      tags: [System]
      summary: Heartbeat state
      description: Returns heartbeat status and registered handler list.
      responses:
        "200":
          description: Heartbeat info
          content:
            application/json:
              schema:
                type: object
                properties:
                  running:
                    type: boolean
                  intervalMs:
                    type: integer
                    description: Tick interval in milliseconds
                  lastTick:
                    type: string
                    format: date-time
                    nullable: true
                  tickCount:
                    type: integer
                  handlers:
                    type: array
                    items:
                      type: object
                      properties:
                        name:
                          type: string
                        description:
                          type: string
                        enabled:
                          type: boolean

  /api/mood:
    get:
      tags: [System]
      summary: Current mood
      description: Returns the bot's current emotional state using Plutchik's wheel of emotions. Updated automatically after each Discord response via mood classification.
      responses:
        "200":
          description: Mood state (active=false when no mood has been set yet)
          content:
            application/json:
              schema:
                type: object
                properties:
                  active:
                    type: boolean
                    description: Whether a mood is currently set
                  emotion:
                    type: string
                    enum: [joy, trust, fear, surprise, sadness, disgust, anger, anticipation]
                  intensity:
                    type: string
                    enum: [low, mid, high]
                  label:
                    type: string
                    description: Resolved emotion word (e.g. "serenity" for joy/low)
                  secondary:
                    type: string
                    nullable: true
                    description: Optional secondary emotion for blends
                  note:
                    type: string
                    nullable: true
                    description: Brief context for why mood shifted
                  updatedAt:
                    type: string
                    format: date-time

  /api/logs:
    get:
      tags: [System]
      summary: Recent log entries
      description: Returns the last 200 log entries.
      responses:
        "200":
          description: Log entries
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: "#/components/schemas/LogEntry"

  /api/logs/stream:
    get:
      tags: [System]
      summary: Live log stream (SSE)
      description: |
        Server-Sent Events stream of log entries in real time.
        Each event is `data: {"ts": "...", "level": "log", "message": "..."}`.
        Use `?token=<key>` for auth (EventSource can't set headers).
      security:
        - QueryToken: []
      responses:
        "200":
          description: SSE stream
          content:
            text/event-stream:
              schema:
                type: string

  /api/reboot:
    post:
      tags: [System]
      summary: Reboot the bot
      description: Triggers a graceful reboot. Response is sent before the process exits.
      responses:
        "200":
          description: Reboot initiated
          content:
            application/json:
              schema:
                type: object
                properties:
                  success:
                    type: boolean
                  message:
                    type: string

  # ── Export ─────────────────────────────────────────────
  /api/export:
    get:
      tags: [Export]
      summary: Export bot data
      description: |
        Returns a JSON bundle of all bot data. Use the `sections` query parameter to
        selectively export specific sections. Response includes a Content-Disposition
        header for browser download.
      parameters:
        - name: sections
          in: query
          schema:
            type: string
          description: "Comma-separated list of sections to include (e.g. `memory,sessions,notes`). Omit for all."
      responses:
        "200":
          description: Data export bundle
          headers:
            Content-Disposition:
              schema:
                type: string
              description: "attachment; filename=aelora-export-YYYY-MM-DD.json"
          content:
            application/json:
              schema:
                type: object
                properties:
                  memory:
                    type: object
                    description: All memory facts by scope
                  sessions:
                    type: array
                    description: All channel sessions
                  notes:
                    type: object
                    description: All notes by scope
                  users:
                    type: object
                    description: All user profiles
                  cron:
                    type: array
                    description: All cron jobs
                  mood:
                    type: object
                    description: Current mood state
                  personas:
                    type: array
                    description: All persona descriptions

  # ── Activity ────────────────────────────────────────────
  /api/activity/config:
    get:
      tags: [Activity]
      summary: Activity client ID
      description: Returns the Discord application client ID for the Activity SDK. Always public (no secret exposed).
      security: []
      responses:
        "200":
          description: Activity config
          content:
            application/json:
              schema:
                type: object
                properties:
                  clientId:
                    type: string
                  enabled:
                    type: boolean

  /api/activity/token:
    post:
      tags: [Activity]
      summary: OAuth2 token exchange
      description: Exchanges a Discord OAuth2 authorization code for an access token. Always public.
      security: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                code:
                  type: string
              required: [code]
      responses:
        "200":
          description: Access token
          content:
            application/json:
              schema:
                type: object
                properties:
                  access_token:
                    type: string
        "400":
          description: Missing code
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Error"
